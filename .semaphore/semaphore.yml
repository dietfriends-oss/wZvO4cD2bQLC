version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: a1-standard-4
    os_image: macos-mojave-xcode11
blocks:
  - name: 'Block 1'
    task:
      # Connect secret to all jobs in the block
      secrets:
        - name: private-repo
        - name: fastlane-env
        - name: firebase-env
      env_vars:
        - name: LC_ALL
          value: en_US.UTF-8
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - chmod 0600 ~/.keys/*
          - ssh-add ~/.keys/*
          - checkout
          - >-
            export GIT_REF=$(git log --format=%B -n 1 | perl -nle'print $& while m{ref: \K[a-f0-9]+}g')
          - echo "git ref - ${GIT_REF}"
          - chmod +x ./github-status-updater_darwin_amd64
          - >-
            ./github-status-updater_darwin_amd64
            -action update_state
            -token ${GITHUB_TOKEN}
            -owner ${GIT_OWNER}
            -repo ${GIT_REPO}
            -ref ${GIT_REF}
            -state pending
            -context "beta-ci"
            -description "Commit status with target URL"
            -url "https://i109euqw5usj.semaphoreci.com/workflows/${SEMAPHORE_WORKFLOW_ID}"
          - git clone git@github.com:${GIT_OWNER}/${GIT_REPO}.git
          - cd ${GIT_REPO}/ios
          - rbenv shell 2.5.1
          - gem install cocoapods -v 1.8.3
          - gem install bundler
          - bundle config set path 'vendor/bundle'
          - bundle install
          - brew install getsentry/tools/sentry-cli
          - flutter upgrade
          - flutter version v1.12.13+hotfix.5
          - flutter doctor
          - >-
            sudo security delete-certificate -c "Apple Worldwide Developer
            Relations Certification Authority"
          - cd ..
          - xcversion select 11.2.1
      jobs:
        - name: Fastlane build
          commands:
            - flutter pub get
            - cd ios
            - pod update && pod install && cd ..
            - ln -s /Users/semaphore/flutter/.pub-cache /Users/semaphore/.pub-cache
            - flutter build ios --no-pub --flavor development --release --no-codesign --target lib/main_dev.dart
            - cd ios
            - curl -sL firebase.tools | bash
            - gem install fastlane -NV
            - bundle exec fastlane install_plugins
            - bundle exec fastlane beta_dev service:SemaphoreCI upload:true
      epilogue:
        always:
          commands:
            - wget https://github.com/cloudposse/github-status-updater/releases/download/0.2.0/github-status-updater_darwin_amd64 -O github-status-updater
            - chmod +x ./github-status-updater
        on_pass:
          commands:
            - >-
              ./github-status-updater
              -action update_state
              -token ${GITHUB_TOKEN}
              -owner ${GIT_OWNER}
              -repo ${GIT_REPO}
              -ref ${GIT_REF}
              -state success
              -context "beta-ci"
              -description "Commit status with target URL"
              -url "https://i109euqw5usj.semaphoreci.com/workflows/${SEMAPHORE_WORKFLOW_ID}"
        on_fail:
          commands:
            - >-
              ./github-status-updater
              -action update_state
              -token ${GITHUB_TOKEN}
              -owner ${GIT_OWNER}
              -repo ${GIT_REPO}
              -ref ${GIT_REF}
              -state failure
              -context "beta-ci"
              -description "Commit status with target URL"
              -url "https://i109euqw5usj.semaphoreci.com/workflows/${SEMAPHORE_WORKFLOW_ID}"
