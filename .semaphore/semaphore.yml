version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: a1-standard-4
    os_image: macos-mojave-xcode11
blocks:
  - name: 'Block #1'
    task:
      # Connect secret to all jobs in the block
      secrets:
        - name: private-repo
        - name: fastlane-env
        - name: firebase-env
      prologue:
        commands:
          - chmod 0600 ~/.keys/*
          - ssh-add ~/.keys/*
          - git clone git@github.com:${GIT_OWNER}/${GIT_REPO}.git
          - cd ${GIT_REPO}/ios
          - rbenv shell 2.5.1
          - gem install cocoapods -v 1.8.3
          - gem install bundler
          - bundle config set path 'vendor/bundle'
          - bundle install
          - brew install getsentry/tools/sentry-cli
          - flutter upgrade
          - flutter version v1.12.13+hotfix.5
          - flutter doctor
          - >-
            sudo security delete-certificate -c "Apple Worldwide Developer
            Relations Certification Authority"
          - cd ..
          - xcversion select 11.2.1
      jobs:
        - name: Fastlane build
          commands:
            - flutter pub get
            - cd ios
            - pod update && pod install && cd ..
            - ln -s /Users/semaphore/flutter/.pub-cache /Users/semaphore/.pub-cache
            - flutter build ios --no-pub --flavor development --release --no-codesign --target lib/main_dev.dart
            - cd ios
            - curl -sL firebase.tools | bash
            - gem install fastlane -NV
            - bundle exec fastlane install_plugins
            - bundle exec fastlane beta_dev service:SemaphoreCI upload:true
